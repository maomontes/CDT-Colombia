---
title: "tasa final"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(tidytext)
library(scales)
library(lubridate)
library(ggrepel)
library(RColorBrewer)
library(extrafont)
library(hrbrthemes)

theme_set(theme_minimal())

df <- readRDS(file = "data/df_dias_cdt_RDS")

df_2020 <- df %>% 
  filter(Year == "2020")


df_2020$Month <- factor(df_2020$Month,
                   levels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun",
                              "Jul", "Ago", "Sept", "Oct", "Nov", "Dic"))

df_2020$descripcion <- factor(df_2020$descripcion,
                         levels = c("A 30 Dias", "A 60 Dias", "A 90 Dias",
                                    "A 120 Dias", "A 180 Dias", "A 360 Dias"))

df_2020$Wday <- factor(df_2020$Wday,
                       levels = c("Lunes", "Martes", "Miercoles", "Jueves",
                                  "Viernes"))
```

##---------------Barplots------------------------

```{r}
# Barplot Entidad por Mes
df_2020 %>% 
  filter(fct_lump(nombreentidad, 5) != "Other") %>% 
  group_by(nombreentidad, Month) %>%
  summarise(count = n(),
            .groups = "drop") %>% 
  ggplot(aes(count, reorder_within(nombreentidad, count, Month))) +
  geom_col(fill = "cadetblue4") +
  scale_y_reordered() +
  facet_wrap(~Month, scales = "free")


# Barplot Entidad por Weekday
df_2020 %>% 
  filter(fct_lump(nombreentidad, 5) != "Other") %>% 
  group_by(nombreentidad, Wday) %>%
  summarise(count = n(),
            .groups = "drop") %>% 
  ggplot(aes(count, reorder_within(nombreentidad, count, Wday))) +
  geom_col() +
  scale_y_reordered() +
  facet_wrap(~Wday, scales = "free")



# Barplot Entidad por Termino(descripcion)
df_2020 %>% 
  filter(fct_lump(nombreentidad, 5) != "Other") %>% 
  group_by(nombreentidad, descripcion) %>% 
  summarise(count = n(),
            .groups = "drop") %>% 
  mutate(nombreentidad = reorder_within(nombreentidad, count, descripcion)) %>% 
  ggplot(aes(count, nombreentidad, fill = descripcion)) +
  geom_col() +
  scale_y_reordered() +
  scale_fill_brewer(type = "qual", palette = 2) +
  facet_wrap(~descripcion, scales = "free_y") +
  theme(legend.position = "none")



  
```








##---------------Lineplots------------------------

```{r}

# Lineplot Avg Tasa in 2020
df_2020 %>% 
  group_by(Month, descripcion) %>% 
  summarise(avg_tasa = mean(tasa),
            avg_monto = mean(monto),
            sd_tasa = sd(tasa),
            .groups = "drop") %>% 
  ggplot(aes(Month, avg_tasa, group = descripcion)) +
  geom_line(aes(color = descripcion), size = 1.5) +
  expand_limits(y = c(0, 6)) + 
  scale_y_continuous(breaks = c(0:6, 1)) +
  theme(legend.position = "top")

# Lineplot Avg Monto 2020
df_2020 %>% 
  group_by(Month, descripcion) %>% 
  summarise(avg_tasa = mean(tasa),
            avg_monto = mean(monto),
            sd_tasa = sd(tasa),
            .groups = "drop") %>% 
  ggplot(aes(Month, avg_monto, group = descripcion)) +
  geom_line(aes(color = descripcion), size = 1.5) +
  # expand_limits(y = c(0, 6)) + 
  scale_y_log10(labels = comma) +
  theme(legend.position = "top")
```

```{r}

df_2020 %>% 
  ggplot(aes(y = monto, x = Month, fill = Month)) +
  geom_boxplot() +
  scale_y_log10() +
  theme(legend.position = "none") +
  facet_wrap(~descripcion)
  
```

